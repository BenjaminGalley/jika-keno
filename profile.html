<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Profile & History | Simba Bet</title>
    <link href="https://fonts.googleapis.com/css2?family=Goldman:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { 
            --gold: #fcc201; 
            --dark: #05070a; 
            --cyan: #00f2ff; 
            --green: #10b981; 
            --red: #ef4444; 
            --card-bg: #111827;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body { 
            font-family: 'Goldman', sans-serif; 
            background: var(--dark); 
            color: white; 
            margin: 0; 
            padding: 0; 
            padding-bottom: 100px; 
        }
        
        .header {
            background: #000;
            padding: 20px;
            text-align: center;
            border-bottom: 2px solid var(--gold);
        }

        .profile-container { padding: 20px; }

        .profile-card { 
            background: var(--card-bg); 
            padding: 20px; 
            border-radius: 15px; 
            border: 1px solid var(--cyan); 
            margin-bottom: 25px; 
            box-shadow: 0 0 15px rgba(0,242,255,0.1); 
        }

        .stat-row { 
            display: flex; 
            justify-content: space-between; 
            margin-bottom: 12px; 
            font-size: 13px; 
            border-bottom: 1px solid rgba(255,255,255,0.05);
            padding-bottom: 8px;
        }
        .stat-row:last-child { border-bottom: none; }
        .stat-row b { color: var(--gold); }

        .history-section { padding: 0 20px; }
        .filter-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .filter-group { display: flex; gap: 8px; overflow-x: auto; scrollbar-width: none; }
        .filter-group::-webkit-scrollbar { display: none; }

        .filter-btn { 
            background: #1e293b; 
            border: none; 
            color: white; 
            padding: 8px 18px; 
            border-radius: 20px; 
            font-size: 11px; 
            cursor: pointer; 
            white-space: nowrap; 
            font-family: 'Goldman';
        }
        .filter-btn.active { background: var(--gold); color: black; font-weight: bold; }

        .history-container { display: flex; flex-direction: column; gap: 12px; }
        .transaction-card { 
            background: #0f172a; 
            padding: 15px; 
            border-radius: 12px; 
            border-left: 4px solid #333; 
            position: relative; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }

        .amount { font-size: 16px; font-weight: bold; position: absolute; right: 15px; top: 15px; }
        .trans-type { font-size: 11px; font-weight: bold; text-transform: uppercase; margin-bottom: 4px; display: block; }
        .trans-date { font-size: 10px; color: #64748b; }
        
        .status-badge { display: inline-block; font-size: 9px; padding: 4px 10px; border-radius: 5px; margin-top: 8px; font-weight: bold; text-transform: uppercase; }
        .status-pending { background: #334155; color: #94a3b8; }
        .status-approved, .status-success { background: rgba(16, 185, 129, 0.2); color: var(--green); border: 1px solid var(--green); }

        .logout-btn {
            background: none;
            color: var(--red);
            border: 1px solid var(--red);
            padding: 10px;
            border-radius: 8px;
            width: 100%;
            margin-top: 20px;
            font-family: 'Goldman';
            font-size: 12px;
            cursor: pointer;
        }

        .nav-bar {
            position: fixed;
            bottom: 0;
            width: 100%;
            background: #000;
            display: flex;
            justify-content: space-around;
            padding: 15px 0 25px;
            border-top: 2px solid var(--gold);
            z-index: 1000;
        }
        .nav-item { color: #64748b; text-decoration: none; font-size: 11px; text-align: center; display: flex; flex-direction: column; gap: 4px; }
        .nav-item.active { color: var(--gold); }
    </style>
</head>
<body onload="initProfile()">

    <div class="header">
        <h2 style="color:var(--gold); font-size: 18px; letter-spacing: 1px;">ACCOUNT CENTER</h2>
    </div>

    <div class="profile-container">
        <div class="profile-card">
            <h3 style="margin-top:0; color:var(--cyan); font-size: 14px; margin-bottom: 15px;">ü¶Å SIMBA PLAYER</h3>
            <div class="stat-row"><span>Username:</span><span id="pName">-</span></div>
            <div class="stat-row"><span>Mobile:</span><span id="pPhone">-</span></div>
            <div class="stat-row"><span>Simba ID:</span><b id="pID">-</b></div>
            <div class="stat-row" style="border:none; margin-top:10px;">
                <span>Wallet:</span>
                <b id="pBal" style="font-size:20px; color:var(--gold);">0.00 ETB</b>
            </div>
            <button class="logout-btn" onclick="logout()">LOGOUT SESSION</button>
        </div>
    </div>

    <div class="history-section">
        <div class="filter-header">
            <h3 style="margin:0; font-size: 14px; color: var(--gold);">HISTORY</h3>
            <div class="filter-group">
                <button class="filter-btn active" onclick="applyFilter(0, this)">Today</button>
                <button class="filter-btn" onclick="applyFilter(3, this)">3 Days</button>
                <button class="filter-btn" onclick="applyFilter(7, this)">7 Days</button>
            </div>
        </div>

        <div id="historyList" class="history-container">
            <div style="text-align:center; padding:40px; color:#444;">Connecting to server...</div>
        </div>
    </div>

    <div class="nav-bar">
        <a href="index.html" class="nav-item"><span>üè†</span><span>Lobby</span></a>
        <a href="deposit.html" class="nav-item"><span>üí∞</span><span>Deposit</span></a>
        <a href="withdraw.html" class="nav-item"><span>üí∏</span><span>Withdraw</span></a>
        <a href="profile.html" class="nav-item active"><span>üë§</span><span>Profile</span></a>
    </div>

    <script>
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzI2sCF2oVeQOSwND3nrF_c9I6wHUVKfb2CpQD6g_F__tZuBWc6NkpecpFwTtEd8bW5/exec";
        let user = JSON.parse(localStorage.getItem('simba_active_user'));
        let rawHistory = [];

        function initProfile() {
            if (!user) { window.location.href = 'login.html'; return; }
            
            document.getElementById('pName').innerText = user.name || "User";
            document.getElementById('pPhone').innerText = user.phone;
            document.getElementById('pID').innerText = user.id || "1000";
            document.getElementById('pBal').innerText = parseFloat(user.balance || 0).toFixed(2) + " ETB";
            
            fetchData();
        }

        async function fetchData() {
            try {
                // Standardizing the action to checkStatus which our Master Script handles
                const response = await fetch(`${SCRIPT_URL}?action=checkStatus&phone=${user.phone}`);
                const data = await response.json();
                
                if(data.balance !== undefined) {
                    user.balance = data.balance;
                    localStorage.setItem('simba_active_user', JSON.stringify(user));
                    document.getElementById('pBal').innerText = parseFloat(data.balance).toFixed(2) + " ETB";
                }

                // If history is not yet active in the script, we show empty rather than error
                rawHistory = data.history || [];
                render(0); 
            } catch (e) {
                console.error("Profile sync failed", e);
                document.getElementById('historyList').innerHTML = "<div style='text-align:center; color:#64748b; padding:20px;'>No history available yet.</div>";
            }
        }

        function applyFilter(days, btn) {
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            render(days);
        }

        function render(daysLimit) {
            const list = document.getElementById('historyList');
            const now = new Date();
            
            if (!rawHistory || rawHistory.length === 0) {
                list.innerHTML = "<div style='text-align:center; padding:30px; color:#444; font-size:12px;'>No activity found.</div>";
                return;
            }

            const filtered = rawHistory.filter(item => {
                const itemDate = new Date(item.date);
                if (daysLimit === 0) return itemDate.toDateString() === now.toDateString();
                const diffDays = (now - itemDate) / (1000 * 60 * 60 * 24);
                return diffDays <= daysLimit;
            });

            list.innerHTML = filtered.map(item => {
                const amt = parseFloat(item.amount);
                const isWithdraw = amt < 0;
                const status = (item.status || "pending").toLowerCase();

                return `
                    <div class="transaction-card" style="border-left-color: ${isWithdraw ? 'var(--red)' : 'var(--green)'}">
                        <span class="trans-type" style="color: ${isWithdraw ? 'var(--red)' : 'var(--green)'}">
                            ${isWithdraw ? 'Withdrawal' : 'Deposit'}
                        </span>
                        <div class="amount" style="color:${isWithdraw ? 'var(--red)' : 'var(--green)'}">
                            ${isWithdraw ? '' : '+'}${amt.toFixed(2)}
                        </div>
                        <div class="trans-date">${new Date(item.date).toLocaleString()}</div>
                        <div class="status-badge status-${status}">${status.toUpperCase()}</div>
                    </div>
                `;
            }).join('');
        }

        function logout() {
            localStorage.removeItem('simba_active_user');
            window.location.href = 'login.html';
        }
    </script>
</body>
</html>

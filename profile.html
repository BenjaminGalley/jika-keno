<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Profile & History | Simba Bet</title>
    <style>
        :root { --gold: #fcc201; --dark: #05070a; --cyan: #00f2ff; --green: #10b981; --red: #ef4444; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--dark); color: white; margin: 0; padding: 20px; }
        
        .profile-card { background: #111827; padding: 20px; border-radius: 15px; border: 1px solid var(--cyan); margin-bottom: 25px; box-shadow: 0 0 15px rgba(0,242,255,0.1); }
        .stat-row { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 14px; }
        .stat-row b { color: var(--gold); }

        .filter-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .filter-group { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 5px; }
        .filter-btn { background: #1e293b; border: none; color: white; padding: 8px 15px; border-radius: 20px; font-size: 12px; cursor: pointer; white-space: nowrap; }
        .filter-btn.active { background: var(--gold); color: black; font-weight: bold; }

        .history-container { display: flex; flex-direction: column; gap: 12px; }
        .transaction-card { background: #1a1d29; padding: 15px; border-radius: 12px; border-left: 4px solid #333; position: relative; }
        .amount { font-size: 18px; font-weight: bold; position: absolute; right: 15px; top: 15px; }
        .trans-type { font-size: 12px; font-weight: bold; text-transform: uppercase; margin-bottom: 4px; display: block; }
        .trans-date { font-size: 11px; color: #64748b; }
        
        /* Status Badges */
        .status-badge { display: inline-block; font-size: 10px; padding: 3px 10px; border-radius: 5px; margin-top: 8px; font-weight: bold; text-transform: uppercase; }
        .status-pending { background: #334155; color: #94a3b8; }
        .status-approve, .status-synced { background: rgba(16, 185, 129, 0.2); color: var(--green); border: 1px solid var(--green); }
        .status-deny, .status-denied-wb { background: rgba(239, 68, 68, 0.2); color: var(--red); border: 1px solid var(--red); }

        .back-btn { display: block; text-align: center; margin-top: 30px; color: var(--gold); text-decoration: none; padding: 12px; border: 1px solid var(--gold); border-radius: 8px; font-weight: bold; }
    </style>
</head>
<body onload="initProfile()">

    <div class="profile-card">
        <h3 style="margin-top:0; color:var(--cyan);">PLAYER PROFILE</h3>
        <div class="stat-row"><span>Name:</span><span id="pName">-</span></div>
        <div class="stat-row"><span>Phone:</span><span id="pPhone">-</span></div>
        <div class="stat-row"><span>Simba ID:</span><b id="pID">-</b></div>
        <div class="stat-row"><span>Wallet Balance:</span><b id="pBal" style="font-size:18px;">0.00 ETB</b></div>
    </div>

    <div class="filter-header">
        <h3 style="margin:0; font-size: 16px;">History</h3>
        <div class="filter-group">
            <button class="filter-btn active" onclick="applyFilter(0, this)">Today</button>
            <button class="filter-btn" onclick="applyFilter(3, this)">3 Days</button>
            <button class="filter-btn" onclick="applyFilter(7, this)">7 Days</button>
        </div>
    </div>

    <div id="historyList" class="history-container">
        <div style="text-align:center; padding:40px; color:#444;">Loading your transactions...</div>
    </div>

    <a href="index.html" class="back-btn">â¬… BACK TO LOBBY</a>

    <script>
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyr8EHHAKYy7q1QyCHVnsFZgPrX2FkAyKa_mSwh4yDz3IFHaO9dBCvN-kaNuG5hZz2P/exec";
        let user = JSON.parse(localStorage.getItem('simba_active_user'));
        let rawHistory = [];

        function initProfile() {
            if (!user) { window.location.href = 'login.html'; return; }
            document.getElementById('pName').innerText = user.name;
            document.getElementById('pPhone').innerText = user.phone;
            document.getElementById('pID').innerText = user.id || "REGISTRATION PENDING";
            document.getElementById('pBal').innerText = parseFloat(user.balance).toFixed(2) + " ETB";
            
            fetchData();
        }

        async function fetchData() {
            try {
                const response = await fetch(`${SCRIPT_URL}?action=checkStatus&phone=${user.phone}`);
                const data = await response.json();
                rawHistory = data.history || [];
                render(0); // Show Today by default
            } catch (e) {
                document.getElementById('historyList').innerHTML = "Connection error.";
            }
        }

        function applyFilter(days, btn) {
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            render(days);
        }

        function render(daysLimit) {
            const list = document.getElementById('historyList');
            const now = new Date();
            
            const filtered = rawHistory.filter(item => {
                const itemDate = new Date(item.date);
                if (daysLimit === 0) return itemDate.toDateString() === now.toDateString();
                const diffDays = (now - itemDate) / (1000 * 60 * 60 * 24);
                return diffDays <= daysLimit;
            });

            if (filtered.length === 0) {
                list.innerHTML = "<div style='text-align:center; padding:30px; color:#444;'>No activity found for this period.</div>";
                return;
            }

            list.innerHTML = filtered.map(item => {
                const isWithdraw = parseFloat(item.amount) < 0;
                const status = item.status.toLowerCase();
                const displayStatus = item.status.replace('-WB', '');

                return `
                    <div class="transaction-card" style="border-left-color: ${isWithdraw ? 'var(--red)' : 'var(--green)'}">
                        <span class="trans-type" style="color: ${isWithdraw ? 'var(--red)' : 'var(--green)'}">
                            ${isWithdraw ? 'Withdrawal Request' : 'Deposit Request'}
                        </span>
                        <div class="amount">${Math.abs(item.amount)} ETB</div>
                        <div class="trans-date">${new Date(item.date).toLocaleString()}</div>
                        <div class="status-badge status-${status}">${displayStatus}</div>
                    </div>
                `;
            }).join('');
        }
    </script>
</body>
</html>

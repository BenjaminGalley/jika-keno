function doGet(e) {
  var action = e.parameter.action;
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var sheet = ss.getSheetByName("Sheet1");
  var data = sheet.getDataRange().getValues();

  // --- 1. ADMIN ACTION: Load Pending Requests into Admin.html ---
  if (action == "getPending") {
    var pending = [];
    for (var i = 1; i < data.length; i++) {
      var status = data[i][6] ? data[i][6].toString().trim() : "";
      // Admin page looks for PENDING (Deposits) or W-PENDING (Withdrawals)
      if (status === "PENDING" || status === "W-PENDING") {
        pending.push({
          row: i + 1,
          phone: data[i][1],
          amount: data[i][4],
          details: data[i][7] || "",
          type: data[i][3]
        });
      }
    }
    return ContentService.createTextOutput(JSON.stringify(pending))
      .setMimeType(ContentService.MimeType.JSON);
  }

  // --- 2. ADMIN ACTION: Approve/Deny from Admin.html buttons ---
  if (action == "updateStatus") {
    var row = parseInt(e.parameter.row);
    var status = e.parameter.status; // "Approve" or "Deny"
    sheet.getRange(row, 7).setValue(status); 
    return ContentService.createTextOutput("Success");
  }

  // --- 3. PLAYER ACTION: Deposit ---
  if (action == "deposit") {
    sheet.appendRow([new Date(), e.parameter.phone, e.parameter.name, "DEPOSIT", e.parameter.amount, "", "PENDING", e.parameter.details]);
    return ContentService.createTextOutput("Success");
  }

  // --- 4. PLAYER ACTION: Check Status (Sync Balance) ---
  if (action == "checkStatus") {
    var phone = e.parameter.phone;
    var total = 0;
    for (var i = 1; i < data.length; i++) {
      var rowPhone = data[i][1] ? data[i][1].toString().trim() : "";
      var rowStatus = data[i][6] ? data[i][6].toString().trim() : "";
      if (rowPhone === phone.toString().trim() && rowStatus === "Approve") {
        total += parseFloat(data[i][4] || 0);
        sheet.getRange(i + 1, 7).setValue("SYNCED"); // Prevent double-pay
      }
    }
    return ContentService.createTextOutput(JSON.stringify({approvedAmount: total}))
      .setMimeType(ContentService.MimeType.JSON);
  }

  // --- 5. REGISTRATION ---
  if (action == "register") {
    sheet.appendRow([new Date(), e.parameter.phone, e.parameter.name, e.parameter.pass, 0, "", "USER"]);
    return ContentService.createTextOutput("Success");
  }
}

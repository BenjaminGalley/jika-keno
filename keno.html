<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simba Keno | Live Draw</title>
    <style>
        :root { --gold: #fbbf24; --bg: #0b0d17; --card: #1a1d29; --blue: #3b82f6; --red: #ef4444; }
        body { background: var(--bg); color: white; font-family: sans-serif; margin: 0; text-align: center; }
        
        /* Header */
        .header { background: var(--card); padding: 10px 15px; border-bottom: 2px solid var(--gold); display: flex; justify-content: space-between; align-items: center; }
        .bal { color: var(--gold); font-weight: bold; font-size: 18px; }

        /* Non-Stop Timer Zone */
        .timer-zone { background: #000; padding: 10px; border-bottom: 1px solid #333; position: relative; }
        #timerBar { position: absolute; bottom: 0; left: 0; height: 3px; background: var(--gold); width: 100%; transition: width 1s linear; }

        /* 80 Number Grid */
        .keno-grid { 
            display: grid; grid-template-columns: repeat(10, 1fr); gap: 4px; 
            padding: 10px; max-width: 450px; margin: auto;
        }
        .num { 
            background: #1e293b; border-radius: 4px; aspect-ratio: 1/1; 
            display: flex; align-items: center; justify-content: center; 
            font-size: 12px; font-weight: bold; cursor: pointer; position: relative; border: 1px solid #333;
        }
        
        /* Fancy Visual States */
        .num.selected { border: 2px solid var(--gold); color: var(--gold); }
        .num.draw-active { background: white; color: black; transform: scale(1.1); z-index: 10; }
        .num.hit { background: var(--blue) !important; color: white !important; box-shadow: 0 0 15px var(--blue); border: none; }
        .num.missed::after { content: "✕"; position: absolute; color: var(--red); font-size: 20px; font-weight: bold; }

        /* Controls */
        .controls { position: fixed; bottom: 0; width: 100%; background: var(--card); padding: 15px; border-top: 2px solid var(--gold); box-sizing: border-box; }
        .bet-row { display: flex; justify-content: center; align-items: center; gap: 20px; margin-bottom: 10px; }
        .adj-btn { background: #334155; color: white; border: none; width: 40px; height: 40px; border-radius: 50%; font-size: 20px; font-weight: bold; }
        .play-btn { background: #22c55e; color: white; border: none; width: 100%; padding: 15px; border-radius: 10px; font-weight: bold; font-size: 18px; }
        .play-btn:disabled { background: #444; color: #888; }
    </style>
</head>
<body>

    <div class="header">
        <button onclick="location.href='index.html'" style="background:var(--gold); border:none; padding:8px 12px; border-radius:5px; font-weight:bold;">LOBBY</button>
        <div class="bal" id="balDisplay">0.00 ETB</div>
    </div>

    <div class="timer-zone">
        DRAW STARTS IN: <span id="timeLeft" style="color:var(--gold)">60</span>s
        <div id="timerBar"></div>
    </div>

    <div class="keno-grid" id="grid"></div>

    <div class="controls">
        <div class="bet-row">
            <button class="adj-btn" onclick="changeBet(-2)">−</button>
            <span style="font-weight:bold">BET: <span id="betAmt" style="color:var(--gold)">2</span> ETB</span>
            <button class="adj-btn" onclick="changeBet(2)">+</button>
        </div>
        <button class="play-btn" id="playBtn" onclick="placeBet()">PLACE BET</button>
    </div>

    <script>
        // Use your verified Google Script URL
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwn1zFZR_nLWrRt-_t1QHJGXUbOtpAvl9xJPh4MgJ-U0vHc-gAufrNf1abnFksBzGc/exec';
        
        let balance = parseFloat(localStorage.getItem('simba_balance')) || 0;
        let bet = 2;
        let selected = [];
        let isBetPlaced = false;
        let timer = 60;
        let canPick = true;

        const multipliers = { 1:[0,3], 2:[0,1,12], 3:[0,0,5,45], 4:[0,0,2,15,100], 5:[0,0,1,5,50,500] };

        function init() {
            const grid = document.getElementById('grid');
            for(let i=1; i<=80; i++) {
                const n = document.createElement('div');
                n.className = 'num'; n.innerText = i;
                n.onclick = () => { if(canPick) toggleNum(i, n); };
                grid.appendChild(n);
            }
            updateUI();
            startNonStopCycle();
        }

        function toggleNum(i, el) {
            if(selected.includes(i)) {
                selected = selected.filter(x => x !== i);
                el.classList.remove('selected');
            } else if(selected.length < 5) {
                selected.push(i);
                el.classList.add('selected');
            }
        }

        function startNonStopCycle() {
            setInterval(() => {
                if(timer > 0) {
                    timer--;
                    document.getElementById('timeLeft').innerText = timer;
                    document.getElementById('timerBar').style.width = (timer/60)*100 + "%";
                } else if (timer === 0) {
                    timer = -1; // Draw in progress
                    runDraw();
                }
            }, 1000);
        }

        async function runDraw() {
            canPick = false;
            document.getElementById('playBtn').disabled = true;
            document.getElementById('timeLeft').innerText = "DRAWING...";

            const drawn = [];
            while(drawn.length < 20) {
                let n = Math.floor(Math.random() * 80) + 1;
                if(!drawn.includes(n)) drawn.push(n);
            }

            const nums = document.querySelectorAll('.num');
            for(let i=0; i<drawn.length; i++) {
                await new Promise(r => setTimeout(r, 150));
                const val = drawn[i];
                const el = nums[val-1];
                el.classList.add('draw-active');
                if(selected.includes(val)) el.classList.add('hit');
                setTimeout(() => el.classList.remove('draw-active'), 300);
            }

            // Show Misses (X)
            selected.forEach(s => {
                if(!drawn.includes(s)) nums[s-1].classList.add('missed');
            });

            // Calculate Win
            if(isBetPlaced) {
                let hits = selected.filter(x => drawn.includes(x)).length;
                let win = bet * (multipliers[selected.length][hits] || 0);
                if(win > 0) {
                    balance += win;
                    alert("WINNER! You hit " + hits + " numbers! +" + win + " ETB");
                }
            }

            setTimeout(resetForNextDraw, 4000);
        }

        function resetForNextDraw() {
            timer = 60;
            canPick = true;
            isBetPlaced = false;
            selected = [];
            document.querySelectorAll('.num').forEach(n => n.classList.remove('selected', 'hit', 'missed', 'draw-active'));
            document.getElementById('playBtn').disabled = false;
            document.getElementById('playBtn').innerText = "PLACE BET";
            updateUI();
        }

        function changeBet(v) { if(canPick) { bet = Math.max(2, bet + v); updateUI(); } }
        
        function placeBet() {
            if(selected.length === 0) return alert("Pick 1-5 numbers!");
            if(balance < bet) return alert("Low Balance!");
            balance -= bet;
            isBetPlaced = true;
            document.getElementById('playBtn').innerText = "BET LOCKED";
            document.getElementById('playBtn').disabled = true;
            updateUI();
        }

        function updateUI() {
            document.getElementById('balDisplay').innerText = balance.toFixed(2) + " ETB";
            document.getElementById('betAmt').innerText = bet;
            localStorage.setItem('simba_balance', balance);
        }

        // Auto-Sync Balance with your Google Script
        setInterval(async () => {
            const user = localStorage.getItem('simba_user');
            if(!user) return;
            try {
                const res = await fetch(`${SCRIPT_URL}?action=check&user=${encodeURIComponent(user)}`);
                const data = await res.json();
                if (data.status === 'accept' && data.type === 'dep') {
                    balance += parseFloat(data.amt);
                    updateUI();
                }
            } catch(e) {}
        }, 5000);

        init();
    </script>
</body>
</html>

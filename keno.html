<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simba Keno Pro</title>
    <style>
        :root { --gold: #fbbf24; --bg: #0b0d17; --win: #22c55e; --loss: #ef4444; --card: #1a1d29; }
        body { background: var(--bg); color: white; font-family: sans-serif; margin: 0; padding: 10px; text-align: center; }
        
        #historySide { position: fixed; right: -210px; top: 0; width: 200px; height: 100%; background: #000; border-left: 2px solid var(--gold); transition: 0.3s; z-index: 100; padding: 10px; overflow-y: auto; text-align: left; }
        #historySide.open { right: 0; }
        
        .selection-strip { background: #000; color: var(--gold); padding: 12px; min-height: 25px; margin: 10px 0; border-radius: 8px; font-weight: bold; border: 1px dashed #444; font-size: 18px; }
        .grid { display: grid; grid-template-columns: repeat(10, 1fr); gap: 4px; max-width: 450px; margin: auto; }
        .num { background: #1e293b; aspect-ratio: 1; display: flex; align-items: center; justify-content: center; border-radius: 4px; font-size: 14px; cursor: pointer; border: 1px solid #000; }
        .num.selected { background: var(--gold); color: black; font-weight: bold; }
        .num.draw-glow { box-shadow: inset 0 0 15px var(--win), 0 0 10px var(--win); border: 2px solid white; z-index: 5; background: var(--win) !important; color: white !important; }

        .ticket-stack { margin: 15px auto; max-width: 400px; display: flex; flex-direction: column-reverse; gap: 6px; }
        .ticket { background: var(--card); border: 1px solid #334155; padding: 10px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; font-size: 12px; }
        .tix-num { display: inline-block; padding: 2px 4px; margin: 0 2px; border-radius: 3px; border: 1px solid #444; }
        .match { background: var(--win); color: white; font-weight: bold; border-color: white; }
        .miss { background: var(--loss); color: white; opacity: 0.8; }

        .timer-bar { font-size: 24px; font-weight: bold; color: var(--gold); margin-bottom: 10px; }
        .locked { opacity: 0.4; pointer-events: none; }
        .bet-btn { background: var(--win); color: white; border: none; width: 95%; padding: 20px; border-radius: 15px; font-size: 24px; font-weight: bold; cursor: pointer; }

        /* ADJUSTED POP UP - SMALLER SIZE */
        #drawOverlay { 
            display: none; position: fixed; top: 0; left: 0; width: 100%; 
            height: 90px; /* Reduced from 120px to show grid better */
            background: linear-gradient(to bottom, rgba(0,0,0,1), rgba(0,0,0,0.85)); 
            border-bottom: 2px solid var(--gold);
            z-index: 200; flex-direction: column; 
            justify-content: center; align-items: center; 
        }
        #bigNum { 
            font-size: 45px; font-weight: 900; color: var(--gold); 
            text-shadow: 0 0 10px var(--gold); margin-top: -2px;
        }
        .draw-status { font-size: 12px; color: white; font-weight: bold; text-transform: uppercase; }

        .bet-controls { display: flex; align-items: center; justify-content: center; gap: 20px; margin: 10px 0; }
        .ctrl-btn { background: #334155; color: white; border: 2px solid var(--gold); border-radius: 50%; width: 40px; height: 40px; font-size: 24px; cursor: pointer; font-weight: bold; }
        .bet-display { font-size: 20px; color: white; font-weight: bold; }
        
        .win-text { color: var(--win); font-weight: bold; }
        .loss-text { color: #888; font-weight: normal; }
    </style>
</head>
<body>

    <div id="drawOverlay">
        <div class="draw-status" id="drawCounter">DRAWING...</div>
        <div id="bigNum">0</div>
    </div>

    <button onclick="document.getElementById('historySide').classList.toggle('open')" style="position:fixed; left:10px; top:10px; background:var(--gold); border:none; padding:8px; border-radius:5px; z-index:101; font-weight:bold;">HISTORY</button>

    <div id="historySide">
        <h3 style="color:var(--gold)">LAST DRAWS</h3>
        <div id="histContent"></div>
    </div>

    <div class="timer-bar" id="timer">DRAW IN: 50s</div>
    
    <div class="grid" id="kenoGrid"></div>

    <div class="selection-strip" id="selStrip">SELECT NUMBERS</div>

    <div class="bet-controls">
        <button class="ctrl-btn" onclick="changeBet(-2)">-</button>
        <div class="bet-display">Stake: <span id="currentBet">2</span> ETB</div>
        <button class="ctrl-btn" onclick="changeBet(2)">+</button>
    </div>

    <div style="margin:10px 0; font-size:16px; color:var(--gold)">Potential Win: <span id="potential">0.00</span> ETB</div>

    <div class="ticket-stack" id="ticketStack"></div>

    <div style="color:var(--gold); font-size:28px; font-weight:bold; margin:15px 0;" id="gameBal">0.00 ETB</div>

    <button class="bet-btn" id="betBtn" onclick="placeTicket()">PLACE TICKET</button>

<script>
    let activeUserData = JSON.parse(localStorage.getItem('simba_active_user'));
    let balance = activeUserData ? parseFloat(activeUserData.balance) : 0.00;
    
    let bet = 2; 
    let selectedNums = [];
    let placedTickets = [];
    let timeLeft = 50; 
    let isLocked = false;

    const grid = document.getElementById('kenoGrid');
    for(let i=1; i<=80; i++){
        let d = document.createElement('div');
        d.className = 'num'; d.innerText = i; d.id = 'n'+i;
        d.onclick = () => {
            if(isLocked) return;
            if(selectedNums.includes(i)) {
                selectedNums = selectedNums.filter(x => x!==i);
                document.getElementById('n'+i).classList.remove('selected');
            } else if(selectedNums.length < 8) {
                selectedNums.push(i);
                document.getElementById('n'+i).classList.add('selected');
            }
            updateSelectionUI();
        };
        grid.appendChild(d);
    }

    function changeBet(val) {
        if(isLocked) return;
        if(val > 0) bet += 2;
        if(val < 0 && bet > 2) bet -= 2;
        document.getElementById('currentBet').innerText = bet;
        updateSelectionUI();
    }

    function updateSelectionUI() {
        document.getElementById('selStrip').innerText = selectedNums.length > 0 ? selectedNums.sort((a,b)=>a-b).join(' - ') : "SELECT NUMBERS";
        const mults = [0, 0, 2, 5, 15, 40, 100, 300, 1000];
        document.getElementById('potential').innerText = (bet * mults[selectedNums.length]).toFixed(2);
    }

    function placeTicket() {
        if(selectedNums.length < 2) return alert("Select at least 2 numbers");
        if(balance < bet) return alert("Insufficient Balance");
        
        balance -= bet;
        placedTickets.push({ nums: [...selectedNums], bet: bet, win: 0, hits: [] });
        renderTickets();
        
        selectedNums = [];
        document.querySelectorAll('.num').forEach(n => n.classList.remove('selected'));
        updateSelectionUI();
        updateUI();
    }

    function renderTickets() {
        const stack = document.getElementById('ticketStack');
        stack.innerHTML = placedTickets.map((t, idx) => `
            <div class="ticket" id="tix${idx}">
                <div>TKT #${idx+1} (${t.bet} ETB): ${t.nums.map(n => `<span class="tix-num" id="t${idx}n${n}">${n}</span>`).join('')}</div>
                <div id="res${idx}"><b>PENDING</b></div>
            </div>
        `).join('');
    }

    setInterval(() => {
        if(timeLeft > 0) {
            timeLeft--;
            document.getElementById('timer').innerText = `DRAW IN: ${timeLeft}s`;
            if(timeLeft <= 10 && !isLocked) {
                isLocked = true;
                document.getElementById('betBtn').disabled = true;
                document.getElementById('betBtn').innerText = "BET LOCKED";
                grid.classList.add('locked');
            }
        } else {
            runDraw();
            timeLeft = 75; 
        }
    }, 1000);

    async function runDraw() {
        let draw = [];
        while(draw.length < 20) {
            let n = Math.floor(Math.random()*80)+1;
            if(!draw.includes(n)) draw.push(n);
        }

        const overlay = document.getElementById('drawOverlay');
        const bigNum = document.getElementById('bigNum');
        const counter = document.getElementById('drawCounter');
        
        overlay.style.display = 'flex';

        let drawCount = 1;
        for(let n of draw) {
            counter.innerText = `NUMBER ${drawCount}/20`;
            bigNum.innerText = n;
            document.getElementById('n'+n).classList.add('draw-glow');
            
            placedTickets.forEach((t, tidx) => {
                if(t.nums.includes(n)) {
                    t.hits.push(n);
                    let hitEl = document.getElementById(`t${tidx}n${n}`);
                    if(hitEl) hitEl.classList.add('match');
                }
            });
            await new Promise(r => setTimeout(r, 800));
            drawCount++;
        }

        // --- CALCULATION PHASE ---
        let sessionTotalWin = 0;
        placedTickets.forEach((t, idx) => {
            const winMults = [0, 0, 2, 5, 15, 40, 100, 300, 1000];
            t.win = t.bet * winMults[t.hits.length];
            sessionTotalWin += t.win;
            balance += t.win;
            
            // Mark losses on ticket
            t.nums.forEach(num => {
                if(!t.hits.includes(num)) {
                    let missEl = document.getElementById(`t${idx}n${num}`);
                    if(missEl) missEl.classList.add('miss');
                }
            });

            // UPDATE INDIVIDUAL TICKET TEXT
            const resEl = document.getElementById(`res${idx}`);
            if(t.win > 0) {
                resEl.innerHTML = `<b class="win-text">WIN: ${t.win.toFixed(2)}</b>`;
            } else {
                resEl.innerHTML = `<b class="loss-text">WIN: 0.00</b>`;
            }
        });

        // FINAL ANNOUNCEMENT IN HEADER
        if(sessionTotalWin > 0) {
            counter.innerText = "CONGRATULATIONS!";
            bigNum.innerText = "WIN: " + sessionTotalWin.toFixed(2);
        } else {
            counter.innerText = "GAME OVER";
            bigNum.innerText = "TRY AGAIN";
        }

        const hist = document.getElementById('histContent');
        hist.innerHTML = `<div style="font-size:11px; margin-bottom:5px; border-bottom:1px solid #333">${new Date().toLocaleTimeString()}<br>${draw.slice(0,10).join(', ')}...</div>` + hist.innerHTML;

        updateUI();

        // Hold result on screen for 10 seconds before resetting
        setTimeout(() => {
            overlay.style.display = 'none';
            placedTickets = [];
            document.getElementById('ticketStack').innerHTML = "";
            document.querySelectorAll('.num').forEach(n => n.classList.remove('draw-glow'));
            isLocked = false;
            document.getElementById('betBtn').disabled = false;
            document.getElementById('betBtn').innerText = "PLACE TICKET";
            grid.classList.remove('locked');
            updateUI();
        }, 10000); 
    }

    function updateUI() {
        document.getElementById('gameBal').innerText = balance.toFixed(2) + " ETB";
        if (activeUserData) {
            activeUserData.balance = balance.toFixed(2);
            localStorage.setItem('simba_active_user', JSON.stringify(activeUserData));
            localStorage.setItem(`user_${activeUserData.phone}`, JSON.stringify(activeUserData));
        }
    }
    updateUI();
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fruit Blast | Simba Casino</title>
    <style>
        :root { --gold: #fbbf24; --bg: #0b0d17; --card: #1a1d29; --win: #22c55e; }
        body { background: var(--bg); color: white; font-family: sans-serif; text-align: center; margin: 0; padding: 10px; overflow-x: hidden; }
        
        .header { display: flex; justify-content: space-between; padding: 10px; }
        
        /* Slot Machine Body */
        .machine-container { 
            background: linear-gradient(180deg, #334155 0%, #0f172a 100%);
            border: 4px solid var(--gold);
            border-radius: 20px;
            padding: 15px;
            display: inline-block;
            box-shadow: 0 0 40px rgba(0,0,0,0.8);
            margin-top: 10px;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(3, 90px);
            grid-template-rows: repeat(3, 90px);
            gap: 8px;
            background: #000;
            padding: 10px;
            border-radius: 10px;
            border: 2px solid #333;
        }

        .cell {
            background: #1e293b;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 45px;
            overflow: hidden;
            position: relative;
        }

        /* Player Balance below machine */
        .player-stats {
            margin: 15px 0;
            padding: 10px;
            background: rgba(0,0,0,0.6);
            border-radius: 10px;
            border: 1px solid var(--gold);
            display: inline-block;
            min-width: 200px;
        }
        .balance-val { color: var(--gold); font-size: 24px; font-weight: bold; }

        /* Payline / Result Info */
        .payline-info { height: 30px; margin: 10px 0; font-weight: bold; color: #94a3b8; font-size: 14px; }

        /* Controls */
        .controls { background: var(--card); padding: 20px; border-radius: 20px 20px 0 0; border-top: 3px solid var(--gold); position: fixed; bottom: 0; left: 0; width: 100%; box-sizing: border-box; }
        .bet-box { display: flex; justify-content: center; align-items: center; gap: 15px; margin-bottom: 15px; }
        .adj-btn { background: #334155; color: white; border: none; width: 45px; height: 45px; border-radius: 50%; font-size: 24px; cursor: pointer; }
        .spin-btn { background: var(--win); color: white; border: none; width: 100%; padding: 18px; border-radius: 15px; font-size: 22px; font-weight: bold; box-shadow: 0 6px #15803d; }
        .spin-btn:active { transform: translateY(3px); box-shadow: 0 2px #15803d; }

        /* Celebration Popup */
        #winPopup {
            display: none;
            position: fixed;
            top: 40%; left: 50%; transform: translate(-50%, -50%);
            z-index: 100; text-align: center; width: 100%;
        }
        .win-text { font-size: 60px; font-weight: 900; color: var(--gold); text-shadow: 0 0 20px #000, 0 0 40px var(--gold); animation: bounce 0.5s infinite alternate; }
        
        @keyframes bounce { from { transform: scale(1); } to { transform: scale(1.2); } }
        .spinning { animation: slideDown 0.1s infinite linear; }
        @keyframes slideDown { from { transform: translateY(-100%); } to { transform: translateY(100%); } }
    </style>
</head>
<body>

    <div class="header">
        <button onclick="location.href='index.html'" style="background:var(--gold); border:none; padding:8px 15px; border-radius:5px; font-weight:bold;">LOBBY</button>
    </div>

    <div class="machine-container">
        <div class="grid" id="slotGrid">
            <div class="cell">üçí</div><div class="cell">üçâ</div><div class="cell">üçã</div>
            <div class="cell">üíé</div><div class="cell">7Ô∏è‚É£</div><div class="cell">üçá</div>
            <div class="cell">üîî</div><div class="cell">üçí</div><div class="cell">üçâ</div>
        </div>
    </div>

    <div class="player-stats">
        <div style="font-size: 12px; color: #888;">YOUR BALANCE</div>
        <div class="balance-val" id="balDisplay">0.00 ETB</div>
    </div>

    <div class="payline-info" id="payline">READY TO SPIN</div>

    <div class="controls">
        <div class="bet-box">
            <button class="adj-btn" onclick="changeBet(-2)">-</button>
            <div style="text-align:center">
                <div style="font-size:10px; color:#888;">BET AMOUNT</div>
                <div style="font-size:20px; font-weight:bold;"><span id="betDisplay">2</span> ETB</div>
            </div>
            <button class="adj-btn" onclick="changeBet(2)">+</button>
        </div>
        <button class="spin-btn" id="spinBtn" onclick="startSpin()">SPIN</button>
    </div>

    <div id="winPopup">
        <div id="bigWinLabel" style="color:white; font-size:20px; letter-spacing:5px;">BIG WIN!</div>
        <div class="win-text" id="winAmountLabel">+100</div>
    </div>

    <script>
        const symbols = ['üçí', 'üçã', 'üçâ', 'üçá', 'üîî', 'üíé', '7Ô∏è‚É£'];
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwn1zFZR_nLWrRt-_t1QHJGXUbOtpAvl9xJPh4MgJ-U0vHc-gAufrNf1abnFksBzGc/exec';
        
        let balance = parseFloat(localStorage.getItem('simba_balance')) || 0;
        let bet = 2;
        let isSpinning = false;

        function updateUI() {
            document.getElementById('balDisplay').innerText = balance.toFixed(2) + " ETB";
            document.getElementById('betDisplay').innerText = bet;
            localStorage.setItem('simba_balance', balance);
        }

        function changeBet(v) {
            if(isSpinning) return;
            bet = Math.max(2, Math.min(100, bet + v));
            updateUI();
        }

        async function startSpin() {
            if (balance < bet) return alert("Low Balance!");
            if (isSpinning) return;

            isSpinning = true;
            balance -= bet;
            updateUI();
            
            document.getElementById('spinBtn').disabled = true;
            document.getElementById('payline').innerText = "SPINNING...";
            document.getElementById('winPopup').style.display = "none";

            const cells = document.querySelectorAll('.cell');
            cells.forEach(c => c.innerHTML = `<div class="spinning">${symbols[Math.floor(Math.random()*7)]}</div>`);

            setTimeout(() => {
                const results = [];
                cells.forEach(c => {
                    const res = symbols[Math.floor(Math.random()*7)];
                    results.push(res);
                    c.innerHTML = res;
                });
                checkResults(results);
            }, 1000);
        }

        function checkResults(s) {
            let winMult = 0;
            let matchType = "";

            // Check Row 2 (Middle Line) - Highest Priority
            if(s[3] === s[4] && s[4] === s[5]) {
                winMult = s[3] === '7Ô∏è‚É£' ? 50 : 10;
                matchType = `MIDDLE LINE: ${s[3]} x3`;
            } 
            // Check Row 1
            else if(s[0] === s[1] && s[1] === s[2]) {
                winMult = 5;
                matchType = `TOP LINE: ${s[0]} x3`;
            }
            // Check Row 3
            else if(s[6] === s[7] && s[7] === s[8]) {
                winMult = 5;
                matchType = `BOTTOM LINE: ${s[6]} x3`;
            }

            if(winMult > 0) {
                const winAmt = bet * winMult;
                balance += winAmt;
                showCelebration(winAmt, winMult >= 20);
                document.getElementById('payline').innerText = matchType;
            } else {
                document.getElementById('payline').innerText = "NO MATCH";
            }

            isSpinning = false;
            document.getElementById('spinBtn').disabled = false;
            updateUI();
        }

        function showCelebration(amt, isBig) {
            const popup = document.getElementById('winPopup');
            const label = document.getElementById('bigWinLabel');
            const amtLabel = document.getElementById('winAmountLabel');
            
            label.innerText = isBig ? "JACKPOT! üî•" : "WINNER!";
            amtLabel.innerText = "+" + amt + " ETB";
            popup.style.display = "block";
            
            setTimeout(() => { popup.style.display = "none"; }, 3000);
        }

        // Bridge Sync
        setInterval(async () => {
            const user = localStorage.getItem('simba_user');
            if(!user) return;
            const res = await fetch(`${SCRIPT_URL}?action=check&user=${encodeURIComponent(user)}`);
            const data = await res.json();
            if (data.status === 'accept' && data.type === 'dep') { balance += parseFloat(data.amt); updateUI(); }
        }, 5000);

        updateUI();
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Fast Keno | Simba Bet</title>
    <style>
        :root { 
            --gold: #FFD700; --cyan: #00f2ff; --green: #2ecc71; 
            --red: #e74c3c; --bg: #05070a; --panel: #1a1e26;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; margin: 0; padding: 0; }
        body { 
            background: var(--bg); color: white; font-family: 'Segoe UI', sans-serif; 
            overflow: hidden; display: flex; flex-direction: column; height: 100vh;
        }

        .header { 
            background: var(--panel); height: 50px; display: flex; 
            justify-content: space-between; align-items: center; padding: 0 15px;
            border-bottom: 2px solid var(--gold); flex-shrink: 0;
        }

        .timer-bar { 
            background: #000; color: var(--cyan); text-align: center; 
            font-size: 22px; font-weight: bold; height: 35px; line-height: 35px;
            border-bottom: 1px solid #333; flex-shrink: 0;
        }

        .game-area { display: flex; flex: 1; min-height: 0; position: relative; }
        
        /* Side Results */
        .draw-sidebar {
            width: 50px; background: #111; border-right: 1px solid #333;
            display: none; flex-direction: column; overflow-y: auto; padding: 5px 0;
        }
        .side-ball { 
            width: 35px; height: 35px; margin: 3px auto; border-radius: 50%; 
            background: var(--gold); color: black; font-weight: 900; 
            display: flex; align-items: center; justify-content: center; font-size: 14px;
            box-shadow: 0 0 5px var(--gold);
        }

        /* The Grid with Fruit Backgrounds */
        .grid-container { flex: 1; display: flex; align-items: center; justify-content: center; padding: 5px; }
        .grid { 
            display: grid; grid-template-columns: repeat(10, 1fr); gap: 4px; 
            width: 100%; max-width: 380px;
        }
        .cell { 
            background-color: #1a1e26;
            background-size: cover;
            background-position: center;
            background-blend-mode: overlay; /* Makes number readable over fruit */
            aspect-ratio: 1; display: flex; 
            align-items: center; justify-content: center; font-size: 14px; 
            font-weight: bold; border: 1px solid #3d4b5f; border-radius: 4px;
            position: relative; transition: 0.2s;
        }
        .cell.selected { background-color: var(--cyan) !important; color: black; border-color: white; transform: scale(1.05); z-index: 2; }
        .cell.hit { background-color: var(--green) !important; color: white; box-shadow: 0 0 15px var(--green); transform: scale(1.1); z-index: 3; }

        .live-calc-area {
            background: #000; padding: 8px 15px; border-top: 1px solid #444;
            display: flex; flex-direction: column; gap: 5px; min-height: 60px;
        }
        .calc-nums { display: flex; flex-wrap: wrap; gap: 5px; min-height: 24px; }
        .calc-ball { width: 24px; height: 24px; background: var(--cyan); color: black; border-radius: 50%; font-size: 11px; display: flex; align-items: center; justify-content: center; font-weight: bold; }
        .win-estimate { color: var(--green); font-weight: bold; font-size: 14px; }

        .tickets-container {
            height: 90px; background: #0a0e14; border-top: 1px solid #333;
            display: flex; overflow-x: auto; padding: 8px; gap: 10px; flex-shrink: 0;
        }
        .ticket-card {
            min-width: 130px; background: #1c222d; border: 1px solid var(--gold);
            border-radius: 6px; padding: 6px; flex-shrink: 0;
        }
        .ticket-header { font-size: 10px; color: var(--gold); display: flex; justify-content: space-between; border-bottom: 1px solid #333; margin-bottom: 4px; }
        .ticket-nums { display: flex; flex-wrap: wrap; gap: 3px; }
        .tn { width: 18px; height: 18px; font-size: 9px; background: #333; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
        .tn.hit { background: var(--green); color: white; }

        .bottom-ui { 
            background: var(--panel); padding: 15px 15px 25px 15px;
            flex-shrink: 0; border-top: 2px solid var(--gold); z-index: 100;
        }
        .ctrl-row { display: flex; justify-content: space-between; align-items: center; gap: 12px; }
        .bet-box { display: flex; align-items: center; background: #000; border: 2px solid var(--gold); border-radius: 25px; height: 50px;}
        .b-btn { background: none; border: none; color: var(--gold); padding: 0 15px; font-size: 24px; font-weight: bold; cursor: pointer;}
        #betVal { width: 45px; text-align: center; background: none; border: none; color: white; font-weight: bold; font-size: 18px; }
        .play-btn { 
            flex: 1; height: 50px; background: linear-gradient(180deg, var(--gold), #b8860b); 
            border: none; border-radius: 25px; font-weight: 900; font-size: 18px; color: #000;
            box-shadow: 0 4px 0 #8c5d00; cursor: pointer;
        }
        .play-btn:active { transform: translateY(2px); box-shadow: 0 2px 0 #8c5d00; }
        .play-btn:disabled { opacity: 0.4; filter: grayscale(1); cursor: default; }

        #draw-ball { 
            position: fixed; top: 40%; left: 50%; transform: translate(-50%, -50%); 
            width: 110px; height: 110px; background: white; border-radius: 50%; 
            color: black; font-size: 50px; font-weight: 900; display: none; 
            align-items: center; justify-content: center; border: 6px solid var(--cyan); z-index: 500;
            box-shadow: 0 0 30px rgba(0,242,255,0.6);
        }
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.95); display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 1000; text-align: center; }
    </style>
</head>
<body onload="init()">

    <div class="header">
        <div style="color:var(--gold); font-weight:bold; font-size: 18px; cursor: pointer;" onclick="window.location.href='index.html'">â—€ LOBBY</div>
        <div style="font-size: 16px; font-weight: bold;">BAL: <span id="liveBal" style="color:var(--green)">0.00</span></div>
        <div id="muteBtn" onclick="toggleMute()" style="cursor:pointer; font-size: 20px;">ðŸ”Š</div>
    </div>

    <div class="timer-bar" id="timer">ROUND STARTING...</div>

    <div class="game-area">
        <div class="draw-sidebar" id="drawSide"></div>
        <div class="grid-container">
            <div class="grid" id="mainGrid"></div>
        </div>
    </div>

    <div class="live-calc-area" id="calcArea">
        <div class="calc-nums" id="calcNums">Pick up to 10 numbers...</div>
        <div class="win-estimate" id="potentialWin">Max Payout: 0.00 ETB</div>
    </div>

    <div class="tickets-container" id="ticketDisplay"></div>

    <div class="bottom-ui" id="controls">
        <div class="ctrl-row">
            <div class="bet-box">
                <button class="b-btn" onclick="adjBet(-2)">-</button>
                <input type="number" id="betVal" value="2" readonly>
                <button class="b-btn" onclick="adjBet(2)">+</button>
            </div>
            <button class="play-btn" id="betBtn" onclick="placeBet()" disabled>PLACE BET</button>
        </div>
    </div>

    <div id="draw-ball">0</div>

    <div id="winOverlay" class="modal">
        <h1 style="color:var(--gold); font-size:50px; text-shadow: 0 0 20px gold;">BIG WIN!</h1>
        <p id="winText" style="font-size:32px; font-weight:bold; color:white; margin:10px 0;"></p>
        <p style="color:#aaa;">Balance Updated!</p>
    </div>

    <div id="loseOverlay" class="modal">
        <h1 style="color:var(--red); font-size:40px;">DRAW FINISHED</h1>
        <p style="font-size:18px; color:white; margin:10px 0;">Good luck next time!</p>
    </div>

    <script>
        const FRUITS = ['orange.jpg', 'lemon.jpg', 'grapes.jpg', 'gold7.jpg'];
        const PATH = 'assets/assets/';
        const PAYOUTS = { 1:0, 2:8, 3:20, 4:45, 5:90, 6:250, 7:800, 8:4000, 9:12000, 10:40000 };

        let activeUser = JSON.parse(localStorage.getItem('simba_active_user'));
        let balance = activeUser ? parseFloat(activeUser.balance) : 0;
        let selected = [];
        let tickets = [];
        let currentBet = 2;
        let timeLeft = 30; // Faster 30s rounds
        let timerActive = true;
        let tableLocked = false;
        let isMuted = false;

        function init() {
            const g = document.getElementById('mainGrid');
            for(let i=1; i<=80; i++) {
                let c = document.createElement('div');
                c.className = 'cell';
                c.id = 'n'+i;
                c.innerText = i;
                
                // Assign a random fruit background from your JPG list
                let fruit = FRUITS[Math.floor(Math.random() * FRUITS.length)];
                c.style.backgroundImage = `url('${PATH}${fruit}')`;
                
                c.onclick = () => selectNum(i);
                g.appendChild(c);
            }
            updateUI();
            startTimer();
        }

        function startTimer() {
            const timerEl = document.getElementById('timer');
            const countdown = setInterval(() => {
                if(timerActive) {
                    timeLeft--;
                    timerEl.innerText = `00:${timeLeft < 10 ? '0'+timeLeft : timeLeft}`;
                    
                    if(timeLeft <= 3) tableLocked = true;
                    
                    if(timeLeft <= 0) {
                        clearInterval(countdown);
                        timerActive = false;
                        runDraw();
                    }
                }
            }, 1000);
        }

        function selectNum(n) {
            if(tableLocked) return;
            const el = document.getElementById('n'+n);
            if(selected.includes(n)) {
                selected = selected.filter(x => x !== n);
                el.classList.remove('selected');
            } else if(selected.length < 10) {
                selected.push(n);
                el.classList.add('selected');
            }
            updateUI();
        }

        function adjBet(v) {
            currentBet = Math.max(2, currentBet + v);
            document.getElementById('betVal').value = currentBet;
            updateUI();
        }

        function updateUI() {
            document.getElementById('liveBal').innerText = balance.toFixed(2);
            const calcBox = document.getElementById('calcNums');
            calcBox.innerHTML = selected.length > 0 ? 
                selected.map(n => `<div class="calc-ball">${n}</div>`).join('') : "Pick up to 10 numbers...";

            let mult = PAYOUTS[selected.length] || 0;
            document.getElementById('potentialWin').innerText = `Max Payout: ${(currentBet * mult).toFixed(2)} ETB`;
            document.getElementById('betBtn').disabled = (selected.length === 0 || tableLocked);

            if(activeUser) {
                activeUser.balance = balance.toFixed(2);
                localStorage.setItem('simba_active_user', JSON.stringify(activeUser));
            }
        }

        function placeBet() {
            if(balance < currentBet) return alert("Low Balance");
            balance -= currentBet;
            tickets.push({ nums: [...selected], bet: currentBet });
            renderTickets();
            selected.forEach(n => document.getElementById('n'+n).classList.remove('selected'));
            selected = [];
            updateUI();
        }

        function renderTickets() {
            const container = document.getElementById('ticketDisplay');
            container.innerHTML = tickets.map((t, i) => `
                <div class="ticket-card">
                    <div class="ticket-header"><span>TICKET #${i+1}</span> <span>${t.bet} ETB</span></div>
                    <div class="ticket-nums">
                        ${t.nums.map(n => `<div class="tn" id="tn-${i}-${n}">${n}</div>`).join('')}
                    </div>
                </div>
            `).join('');
            container.scrollLeft = container.scrollWidth;
        }

        async function runDraw() {
            document.getElementById('timer').innerText = "DRAW IN PROGRESS";
            document.getElementById('controls').style.opacity = '0.3';
            
            let drawn = [];
            const side = document.getElementById('drawSide');
            const ballPopup = document.getElementById('draw-ball');
            side.style.display = 'flex';
            side.innerHTML = "";

            for(let i=0; i<20; i++) {
                let n; do { n = Math.floor(Math.random()*80)+1; } while(drawn.includes(n));
                drawn.push(n);

                side.innerHTML += `<div class="side-ball">${n}</div>`;
                side.scrollTop = side.scrollHeight;
                ballPopup.innerText = n; ballPopup.style.display = 'flex';
                document.getElementById('n'+n).classList.add('hit');
                
                tickets.forEach((t, tIdx) => {
                    if(t.nums.includes(n)) {
                        const tnEl = document.getElementById(`tn-${tIdx}-${n}`);
                        if(tnEl) tnEl.classList.add('hit');
                    }
                });

                await new Promise(r => setTimeout(r, 600));
                ballPopup.style.display = 'none';
            }

            let winTotal = 0;
            tickets.forEach(t => {
                let matches = t.nums.filter(n => drawn.includes(n)).length;
                if(matches >= 2) winTotal += t.bet * (PAYOUTS[matches] / 5); 
            });

            if(winTotal > 0) {
                balance += winTotal;
                document.getElementById('winText').innerText = winTotal.toFixed(2) + " ETB";
                document.getElementById('winOverlay').style.display = 'flex';
                updateUI();
            } else if(tickets.length > 0) {
                document.getElementById('loseOverlay').style.display = 'flex';
            }

            setTimeout(() => location.reload(), 4000);
        }

        function toggleMute() {
            isMuted = !isMuted;
            document.getElementById('muteBtn').innerText = isMuted ? "ðŸ”‡" : "ðŸ”Š";
        }
    </script>
</body>
</html>

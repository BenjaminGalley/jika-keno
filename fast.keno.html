<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Fast Keno 80 | Simba Bet</title>
    <link href="https://fonts.googleapis.com/css2?family=Goldman:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { 
            --gold: #fcc201; 
            --blue: #00f2ff; 
            --dark: #000000;
            --hit: #28a745;
            --miss: #dc3545;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        
        body { 
            background: var(--dark); color: white; font-family: 'Goldman', sans-serif; 
            height: 100vh; display: flex; flex-direction: column; overflow: hidden;
        }

        .header { 
            display: flex; justify-content: space-between; padding: 10px; 
            background: #111; border-bottom: 2px solid var(--gold); align-items: center; z-index: 100;
        }

        .status-bar { 
            background: #051a05; padding: 8px; border-bottom: 1px solid var(--blue); text-align: center; 
        }
        .timer { color: var(--blue); font-weight: bold; font-size: 20px; text-shadow: 0 0 10px var(--blue); }

        .game-body { flex: 1; display: flex; overflow: hidden; position: relative; }

        /* Sidebar - No blinking, smooth prepending */
        .side-board { 
            width: 65px; background: #0a0a0a; border-right: 1px solid #333; 
            display: flex; flex-direction: column; align-items: center; gap: 6px; padding: 10px 0;
            overflow-y: auto; scroll-behavior: smooth;
        }
        .side-ball { 
            width: 35px; height: 35px; background: var(--blue); color: #000; 
            border-radius: 50%; display: flex; align-items: center; justify-content: center; 
            font-size: 14px; font-weight: 900; animation: ballPop 0.3s ease-out;
        }

        @keyframes ballPop { from { transform: translateX(-20px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        .main-content { flex: 1; display: flex; flex-direction: column; overflow: hidden; position: relative; }

        .keno-grid { 
            display: grid; grid-template-columns: repeat(10, 1fr); gap: 4px; padding: 10px; background: #000;
        }
        
        .num-btn { 
            aspect-ratio: 1; background: #1a1a1a; border: 1px solid #333; color: white; 
            display: flex; align-items: center; justify-content: center; font-size: 14px; border-radius: 6px;
            transition: 0.2s;
        }
        .num-btn.selected { background: var(--gold); color: #000; font-weight: bold; border-color: #fff; transform: scale(0.95); }
        .num-btn.locked { opacity: 0.5; filter: grayscale(1); }

        .ticket-tray { 
            height: 110px; display: flex; overflow-x: auto; gap: 10px; padding: 10px; 
            background: #050505; border-top: 1px solid #222;
        }
        .ticket { 
            min-width: 150px; background: #111; border: 1px solid #444; border-radius: 10px; padding: 8px; font-size: 11px;
        }
        .t-nums { display: flex; flex-wrap: wrap; gap: 4px; margin-top: 5px; }
        .t-ball { 
            width: 22px; height: 22px; background: #333; border-radius: 50%; 
            display: flex; align-items: center; justify-content: center; font-size: 10px; transition: 0.3s;
        }
        .t-ball.hit { background: var(--hit) !important; color: white; box-shadow: 0 0 8px var(--hit); }
        .t-ball.miss { background: var(--miss) !important; color: white; opacity: 0.6; }

        #drawPopup { 
            position: absolute; top: 35%; left: 50%; transform: translate(-50%, -50%); 
            font-size: 120px; font-weight: 900; color: var(--blue); text-shadow: 0 0 40px var(--blue); 
            z-index: 1000; display: none; pointer-events: none;
        }

        .footer { background: #111; border-top: 2px solid var(--gold); padding: 15px; }
        .bet-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .place-bet-btn { 
            width: 100%; padding: 18px; background: var(--gold); border: none; border-radius: 12px; 
            font-weight: 900; font-size: 22px; color: #000; text-transform: uppercase;
        }
        .place-bet-btn:disabled { background: #333; color: #666; }
    </style>
</head>
<body>

    <div class="header">
        <button onclick="location.href='index.html'" style="background:none; border:1px solid var(--gold); color:var(--gold); padding:8px 15px; border-radius:8px; font-weight:bold;">LOBBY</button>
        <div style="color:var(--gold); font-weight:bold; font-size: 20px;"><span id="bal">0.00</span> ETB</div>
    </div>

    <div class="status-bar">
        <div class="timer" id="timer">DRAW STARTING...</div>
    </div>

    <div class="game-body">
        <div class="side-board" id="sideBoard"></div>
        <div class="main-content">
            <div id="drawPopup">00</div>
            <div class="keno-grid" id="grid"></div>
            <div class="ticket-tray" id="ticketTray"></div>
        </div>
    </div>

    <div class="footer">
        <div class="bet-row">
            <div style="font-size: 13px; color: #888;">Potential: <span id="potWin" style="color:var(--blue)">0.00</span></div>
            <div style="display:flex; align-items:center; gap:15px;">
                <button onclick="adjBet(-5)" style="width:35px; height:35px; border-radius:50%; border:1px solid var(--gold); background:none; color:var(--gold);">-</button>
                <span id="betDisp" style="font-size:20px; font-weight:bold; color:var(--gold);">5</span>
                <button onclick="adjBet(5)" style="width:35px; height:35px; border-radius:50%; border:1px solid var(--gold); background:none; color:var(--gold);">+</button>
            </div>
        </div>
        <button class="place-bet-btn" id="betBtn" onclick="placeBet()">PLACE BET</button>
    </div>

    <audio id="sndPop" src="https://assets.mixkit.co/active_storage/sfx/2045/2045-preview.mp3"></audio>

    <script>
        const WALLET_URL = "YOUR_WALLET_SCRIPT_URL"; // Existing balances script
        const CTRL_URL = "YOUR_NEW_CONTROLLER_URL"; // We will create this next
        
        let selected = [];
        let balance = 0;
        let currentBet = 5;
        let timeLeft = 60;
        let tickets = [];
        let isLocked = false;
        let user = JSON.parse(localStorage.getItem('simba_active_user'));

        const PAYOUTS = {
            2: [0, 1, 8],
            3: [0, 1, 3, 15],
            4: [0, 0, 2, 8, 50],
            5: [0, 0, 1, 5, 20, 100],
            6: [0, 0, 1, 3, 10, 40, 400],
            7: [0, 0, 0, 2, 8, 25, 100, 1000],
            8: [0, 0, 0, 1, 5, 20, 80, 500, 5000],
            9: [0, 0, 0, 1, 3, 15, 60, 250, 1500, 10000],
            10: [0, 0, 0, 0, 2, 10, 50, 200, 1000, 5000, 25000]
        };

        function init() {
            if(!user) { window.location.href = 'login.html'; return; }
            balance = parseFloat(user.balance);
            document.getElementById('bal').innerText = balance.toFixed(2);
            
            const grid = document.getElementById('grid');
            for(let i=1; i<=80; i++) {
                let d = document.createElement('div');
                d.className = 'num-btn';
                d.innerText = i;
                d.id = `n${i}`;
                d.onclick = () => toggle(i);
                grid.appendChild(d);
            }
            startTimer();
        }

        function toggle(n) {
            if(isLocked) return;
            const el = document.getElementById(`n${n}`);
            if(selected.includes(n)) {
                selected = selected.filter(x => x !== n);
                el.classList.remove('selected');
            } else if(selected.length < 10) {
                selected.push(n);
                el.classList.add('selected');
            }
            updatePotential();
        }

        function updatePotential() {
            let count = selected.length;
            let win = (count >= 2) ? PAYOUTS[count][count] * currentBet : 0;
            document.getElementById('potWin').innerText = win.toFixed(2);
        }

        function adjBet(v) {
            if(isLocked) return;
            if(currentBet + v >= 5) { currentBet += v; updateUI(); updatePotential(); }
        }

        async function placeBet() {
            if(selected.length < 2) return alert("Select 2-10 numbers");
            if(balance < currentBet) return alert("Low Balance");

            balance -= currentBet;
            updateUI();
            
            // Sync with Server (Instant deduction)
            fetch(`${WALLET_URL}?action=updateBalance&phone=${user.phone}&balance=${balance.toFixed(2)}`, {mode:'no-cors'});

            tickets.push({
                id: tickets.length + 1,
                nums: [...selected],
                amt: currentBet,
                type: selected.length
            });
            
            renderTickets();
            
            // AUTOMATIC TABLE CLEAR for next bet
            selected = [];
            document.querySelectorAll('.num-btn').forEach(b => b.classList.remove('selected'));
            updatePotential();
        }

        function renderTickets() {
            const tray = document.getElementById('ticketTray');
            tray.innerHTML = tickets.map(t => `
                <div class="ticket" id="tkt-${t.id}">
                    <div style="color:var(--gold); display:flex; justify-content:space-between;">
                        <b>#${t.id}</b> <span>${t.amt} ETB</span>
                    </div>
                    <div class="t-nums">
                        ${t.nums.map(n => `<div class="t-ball" id="tb-${t.id}-${n}">${n}</div>`).join('')}
                    </div>
                </div>
            `).join('');
            tray.scrollLeft = tray.scrollWidth;
        }

        function startTimer() {
            const timerEl = document.getElementById('timer');
            const loop = setInterval(() => {
                if(timeLeft > 0) {
                    timeLeft--;
                    timerEl.innerText = `NEXT DRAW: 00:${timeLeft < 10 ? '0'+timeLeft : timeLeft}`;
                    if(timeLeft <= 5) { 
                        isLocked = true; 
                        document.getElementById('betBtn').disabled = true;
                        document.querySelectorAll('.num-btn').forEach(b => b.classList.add('locked'));
                    }
                } else {
                    runDraw();
                    timeLeft = 75; // 60s bet + 15s draw
                }
            }, 1000);
        }

        async function runDraw() {
            isLocked = true;
            let drawn = [];
            const side = document.getElementById('sideBoard');
            const popup = document.getElementById('drawPopup');
            
            // RESET BOARD FOR DRAW
            side.innerHTML = '';
            popup.style.display = 'block';

            // CONTACT CONTROLLER FOR RTP LOGIC
            let forceDifficulty = "normal";
            try {
                let req = await fetch(`${CTRL_URL}?action=getKenoLogic&phone=${user.phone}`);
                let res = await req.json();
                forceDifficulty = res.mode; 
            } catch(e) { forceDifficulty = "normal"; }

            for(let i=0; i<20; i++) {
                let r = Math.floor(Math.random()*80)+1;
                while(drawn.includes(r)) r = Math.floor(Math.random()*80)+1;
                drawn.push(r);
                
                // POPUP HARMONY
                popup.innerText = r;
                document.getElementById('sndPop').currentTime = 0;
                document.getElementById('sndPop').play();

                // SIDE BOARD HARMONY (One by one, no blink)
                let ball = document.createElement('div');
                ball.className = 'side-ball';
                ball.innerText = r;
                side.prepend(ball);

                // MARK TICKETS IN REAL TIME (Green/Red harmony)
                tickets.forEach(t => {
                    let tb = document.getElementById(`tb-${t.id}-${r}`);
                    if(tb) tb.classList.add('hit');
                });

                await new Promise(res => setTimeout(res, 600)); // Smooth draw speed
            }

            popup.style.display = 'none';
            finalizeRound(drawn);
        }

        function finalizeRound(drawn) {
            let totalWin = 0;
            tickets.forEach(t => {
                let hits = t.nums.filter(n => drawn.includes(n)).length;
                let multiplier = PAYOUTS[t.type][hits] || 0;
                let win = multiplier * t.amt;
                totalWin += win;
                
                // Mark misses on tickets for clarity
                t.nums.forEach(n => {
                    if(!drawn.includes(n)) document.getElementById(`tb-${t.id}-${n}`).classList.add('miss');
                });
            });

            if(totalWin > 0) {
                balance += totalWin;
                updateUI();
                fetch(`${WALLET_URL}?action=updateBalance&phone=${user.phone}&balance=${balance.toFixed(2)}`, {mode:'no-cors'});
            }

            // Prepare for next continuous loop
            setTimeout(() => {
                tickets = [];
                isLocked = false;
                document.getElementById('ticketTray').innerHTML = '';
                document.getElementById('sideBoard').innerHTML = '';
                document.getElementById('betBtn').disabled = false;
                document.querySelectorAll('.num-btn').forEach(b => {
                    b.classList.remove('locked');
                    b.classList.remove('selected');
                });
            }, 5000);
        }

        function updateUI() {
            document.getElementById('bal').innerText = balance.toFixed(2);
            document.getElementById('betDisp').innerText = currentBet;
            user.balance = balance.toFixed(2);
            localStorage.setItem('simba_active_user', JSON.stringify(user));
        }

        window.onload = init;
    </script>
</body>
</html>
